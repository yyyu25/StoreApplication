<h1>Product Catalog</h1>
<div class="container">
    <% @products.each do |product| %>
        <div class="single_item">

            <% if product.image.attached? %>
                <%= image_tag(product.image)  %>
            <% end %>

            <h5><%= link_to product.name, shopper_path(product), class:"link-btn", style: "font-size:1.3em" %></h5>

            <p><%= product.description %></p>

            <h3>$<%= product.price %></h3>

            <%= button_to "Add to Cart",
                cartitems_path(product_id: product.id),
                method: :post,
                form: { data: { turbo: false } },
                class: "btn add_cart-btn",
                data: { product_id: product.id }
            %>
        </div>
        <div class="offcanvas offcanvas-end" tabindex="-1" id="cartPanel-<%= product.id %>">
            <div class="offcanvas-header">
                <%= link_to "Continue shopping", shopper_index_path, class:"link-btn" %>
                <%= link_to "ðŸ›’ Go to cart", cart_path(session[:cart_id]), class:"link-btn" %> 

                <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
            </div>

            <hr>

            <div class="offcanvas-body">
                <p style="text-align:center; margin-bottom: 10px;"> âœ… Added to cart</p>

                <div class="cart-item">
                    <% if product.image.attached? %>
                        <%= image_tag product.image, style: "width:300px; background-color: white; border: solid 0.5px beige;" %>
                    <% end %>
                    <p>
                    <strong>$<%= product.price %></strong>
                    </p>
                </div>

                <hr>

                <a class="btn btn-primary w-100" href="<%= cart_path(session[:cart_id])%>">
                    Go to Cart
                </a>
            </div>
        </div>

    <% end %>
</div>
<script>
    document.addEventListener("DOMContentLoaded", () => {
    const url = new URL(window.location);
    const addedId = url.searchParams.get("added");

    if (addedId) {
        const panel = document.querySelector(`#cartPanel-${addedId}`);
        if (panel) {
        const offcanvas = new bootstrap.Offcanvas(panel, { backdrop: false });
        offcanvas.show();
        }

        url.searchParams.delete("added");
        window.history.replaceState({}, "", url);
    }
    });
</script>
