<div class="search-bar" style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:20px; ">
    <%= form_with url: shopper_index_path, method: :get, local: true, data: { turbo: false }  do %>
    <%= text_field_tag :query, params[:query], placeholder: "Search for items...", style:"width:400px; height:40px; font-size:18px; padding:8px;" %>
    <%= submit_tag "Search", class: "btn btn-outline-secondary" %>
    <% end %>
    <% if params[:query].present? %>
      <%= link_to "Clear", shopper_index_path, class: "btn btn-outline-secondary", style: "height:40px;" %>
    <% end %>
</div>

<% if params[:query].present? %>
  <div style="text-align:center; margin-bottom:20px;">
    <p style="font-size:1.1em; color:#666;">
      <% if @products.any? %>
        Found <strong><%= @products.count %></strong> result(s) for "<strong><%= params[:query] %></strong>"
      <% else %>
        No results found for "<strong><%= params[:query] %></strong>"
      <% end %>
    </p>
  </div>
<% end %>

<div class="container" id="products-container">
    <% if @products.any? %>
      <% @products.each do |product| %>
        <div class="single_item">

            <% if product.image.attached? %>
                <%= image_tag(product.image)  %>
            <% end %>

            <span><%= link_to product.name, shopper_path(product), class:"link-btn", style: "font-size:1.3em" %></span>

            <h3>$<%= product.price %></h3>

            <%= button_to "Add to Cart",
                cartitems_path(product_id: product.id),
                method: :post,
                form: { data: { turbo: false } },
                class: "btn add_cart-btn",
                data: { product_id: product.id }
            %>
        </div>
        <div class="offcanvas offcanvas-end" tabindex="-1" id="cartPanel-<%= product.id %>">
            <div class="offcanvas-header">
                <%= link_to "Continue shopping", shopper_index_path, class:"link-btn" %>
                <%= link_to "ðŸ›’ Go to cart", cart_path(session[:cart_id]), class:"link-btn" %> 

                <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
            </div>

            <hr>

            <div class="offcanvas-body">
                <p style="text-align:center; margin-bottom: 10px;"> âœ… Added to cart</p>

                <div class="cart-item">
                    <% if product.image.attached? %>
                        <%= image_tag product.image, style: "width:300px; background-color: white; border: solid 0.5px beige;" %>
                    <% end %>
                    <p>
                    <strong>$<%= product.price %></strong>
                    </p>
                </div>

                <hr>

                <a class="btn btn-primary w-100" href="<%= cart_path(session[:cart_id])%>">
                    Go to Cart
                </a>
            </div>
        </div>

      <% end %>
    <% else %>
      <div style="text-align:center; padding:40px;">
        <% if params[:query].present? %>
          <p style="font-size:1.2em; color:#999;">No products found matching your search.</p>
        <% else %>
          <p style="font-size:1.2em; color:#999;">No products available.</p>
        <% end %>
      </div>
    <% end %>
</div>
<script>
    document.addEventListener("DOMContentLoaded", () => {
    const url = new URL(window.location);
    const addedId = url.searchParams.get("added");

    if (addedId) {
        const panel = document.querySelector(`#cartPanel-${addedId}`);
        if (panel) {
        const offcanvas = new bootstrap.Offcanvas(panel, { backdrop: false });
        offcanvas.show();
        }

        url.searchParams.delete("added");
        window.history.replaceState({}, "", url);
    }
    });
</script>
